#include "embedia_debug.h"
#include "distances.h"
#include "neural_net.h"
#include "knn.h"
#include "common.h"
#include "skl_knn_iris_model.h"

// Initialization function prototypes
normalization_layer_t init_Standard_Scaler_data(void);
k_neighbors_classifier_layer_t init_SKL_KNN_iris_model_data(void);


// Global Variables
normalization_layer_t Standard_Scaler_data;
k_neighbors_classifier_layer_t SKL_KNN_iris_model_data;


void model_init(){
    Standard_Scaler_data = init_Standard_Scaler_data();
    SKL_KNN_iris_model_data = init_SKL_KNN_iris_model_data();

}

void model_predict(data1d_t input, data1d_t * output){
  
    prepare_buffers();
    
    //******************** LAYER 0 *******************//
    // Layer name: Standard_Scaler
    data1d_t output0;
    standard_norm_layer(Standard_Scaler_data, input, &output0);
    // Debug function for layer Standard_Scaler
    print_data1d_t("Standard_Scaler", output0);
    
    //******************** LAYER 1 *******************//
    // Layer name: SKL_KNN_iris_model
    input = output0;
    k_neighbors_classifier_layer(SKL_KNN_iris_model_data, input, &output0);
    
    // Debug function for layer SKL_KNN_iris_model
    print_data1d_t("SKL_KNN_iris_model", output0);
    

    *output = output0;

}

int model_predict_class(data1d_t input, data1d_t * results){
  
   
    model_predict(input, results);
    
    return argmax(*results);
    //return argmax(data1d_t);

}

// Implementation of initialization functions


normalization_layer_t init_Standard_Scaler_data(void){
    /*[5.80916667 3.06166667 3.72666667 1.18333333]*/
    static const fixed sub_val[] ={
    1487, 784, 954, 303
    };
    /*[1.21896909 2.23589719 0.57305675 1.33485032]*/
    static const fixed inv_div_val[] ={
    312, 572, 147, 342
    };

    static const normalization_layer_t norm = { sub_val, inv_div_val  };
    return norm;
}

        
    k_neighbors_classifier_layer_t init_SKL_KNN_iris_model_data(void){
    
        uint16_t n_neighbors = 5;
        uint32_t n_samples = 120;
        uint16_t n_features = 4;
        uint16_t n_classes = 3;

    
        static fixed neighbors_features[] = {
/* 0 */ -377, 308, -400, -336,
/* 0 */ -34, 766, -327, -268,
/* 1 */ 278, 22, 99, 74,
/* 0 */ -315, 194, -312, -336,
/* 0 */ -440, 79, -356, -336,
/* 2 */ 153, -321, 187, 245,
/* 1 */ 184, 79, 113, 108,
/* 0 */ -190, 251, -327, -336,
/* 0 */ -253, 308, -341, -336,
/* 0 */ -190, 594, -327, -370,
/* 2 */ -3, -207, 201, 245,
/* 1 */ 60, 194, 113, 142,
/* 1 */ 278, 22, 143, 108,
/* 0 */ -128, 480, -356, -268,
/* 0 */ -128, 365, -327, -336,
/* 1 */ -96, -379, -4, -63,
/* 2 */ 153, -150, 201, 108,
/* 2 */ 184, 22, 260, 211,
/* 1 */ 247, -35, 99, 74,
/* 2 */ 434, 308, 348, 450,
/* 1 */ -34, -93, 69, 40,
/* 2 */ 559, -35, 422, 313,
/* 1 */ -65, -35, 113, 108,
/* 0 */ -221, 251, -341, -336,
/* 2 */ 590, -150, 436, 279,
/* 1 */ -3, -207, 55, -63,
/* 0 */ -190, 194, -341, -336,
/* 0 */ -253, 251, -356, -302,
/* 0 */ -221, 423, -268, -268,
/* 1 */ -253, -608, -33, -63,
/* 2 */ 153, -207, 172, 211,
/* 0 */ -315, 194, -268, -336,
/* 0 */ -253, -35, -312, -336,
/* 0 */ -221, 136, -297, -234,
/* 1 */ -65, -207, 69, 40,
/* 0 */ -221, 194, -327, -336,
/* 1 */ -34, -35, 69, 6,
/* 2 */ 590, 423, 436, 347,
/* 0 */ -377, 79, -341, -336,
/* 1 */ 122, -93, 84, 40,
/* 2 */ -34, -321, 187, 279,
/* 0 */ -96, 652, -341, -336,
/* 2 */ 60, -35, 157, 211,
/* 2 */ -3, -207, 201, 245,
/* 1 */ 60, -493, 40, -63,
/* 1 */ -128, -35, 113, 108,
/* 2 */ 122, 194, 245, 382,
/* 1 */ -96, -436, 40, 40,
/* 0 */ -128, 480, -297, -268,
/* 1 */ -253, -436, -63, -63,
/* 2 */ 184, -207, 231, 245,
/* 0 */ -253, 136, -341, -336,
/* 0 */ -253, 79, -371, -336,
/* 1 */ -96, -379, 11, -28,
/* 1 */ 278, -35, 187, 177,
/* 0 */ -284, 22, -327, -336,
/* 2 */ -3, -150, 201, 416,
/* 0 */ -253, 194, -327, -336,
/* 0 */ -253, 251, -312, -199,
/* 1 */ 28, 79, 157, 211,
/* 1 */ -221, -321, -107, -28,
/* 2 */ 340, 79, 289, 382,
/* 1 */ 60, -207, 201, 142,
/* 2 */ 91, -264, 275, 74,
/* 2 */ 590, -35, 348, 382,
/* 1 */ -96, -321, 40, 40,
/* 0 */ -440, -93, -341, -336,
/* 0 */ -471, -35, -385, -370,
/* 2 */ 60, -493, 187, 108,
/* 2 */ 434, 79, 334, 211,
/* 0 */ -377, 22, -327, -336,
/* 0 */ -221, 251, -341, -302,
/* 0 */ -440, -35, -356, -336,
/* 1 */ 153, -321, 172, 108,
/* 2 */ 153, 194, 275, 416,
/* 0 */ -377, 194, -341, -302,
/* 2 */ 309, -35, 260, 313,
/* 2 */ 153, 136, 334, 450,
/* 0 */ -346, 79, -356, -336,
/* 1 */ 91, -93, 143, 74,
/* 1 */ 216, -150, 128, 108,
/* 2 */ 122, -150, 157, 211,
/* 1 */ 372, 79, 143, 74,
/* 2 */ 184, 79, 231, 382,
/* 0 */ -221, 423, -312, -336,
/* 2 */ 340, 22, 245, 313,
/* 1 */ 28, -35, 69, 108,
/* 2 */ 216, -35, 216, 279,
/* 1 */ -34, -264, -33, -63,
/* 1 */ -190, -207, 25, 74,
/* 1 */ 91, -35, 128, 74,
/* 0 */ -409, -436, -356, -302,
/* 1 */ 247, -93, 128, 40,
/* 1 */ -96, -264, 99, 6,
/* 0 */ -159, 365, -327, -336,
/* 1 */ -65, -35, 55, 40,
/* 2 */ 465, -93, 378, 211,
/* 2 */ 278, 136, 289, 313,
/* 0 */ -221, 365, -327, -268,
/* 1 */ -284, -379, -63, -63,
/* 2 */ 278, 136, 289, 450,
/* 2 */ 434, -35, 304, 142,
/* 0 */ -284, 308, -341, -370,
/* 2 */ 278, 22, 275, 416,
/* 0 */ -284, -35, -341, -336,
/* 1 */ 340, 22, 172, 108,
/* 2 */ 496, -150, 348, 245,
/* 2 */ 153, -93, 275, 211,
/* 1 */ -34, -150, 55, 40,
/* 2 */ 216, -35, 260, 211,
/* 1 */ 153, -436, 99, 40,
/* 1 */ 184, -93, 84, 40,
/* 2 */ -65, -150, 172, 279,
/* 2 */ 28, -35, 201, 211,
/* 0 */ -128, 194, -297, -336,
/* 1 */ 91, -150, 40, 40,
/* 2 */ -284, -321, 113, 177,
/* 0 */ -3, 537, -371, -336,
/* 1 */ -3, -264, 40, 6,
/* 2 */ 403, -35, 319, 313,
};
        static uint16_t neighbors_id[] = {0,0,1,0,0,2,1,0,0,0,2,1,1,0,0,1,2,2,1,2,1,2,1,0,2,1,0,0,0,1,2,0,0,0,1,0,1,2,0,1,2,0,2,2,1,1,2,1,0,1,2,0,0,1,1,0,2,0,0,1,1,2,1,2,2,1,0,0,2,2,0,0,0,1,2,0,2,2,0,1,1,2,1,2,0,2,1,2,1,1,1,0,1,1,0,1,2,2,0,1,2,2,0,2,0,1,2,2,1,2,1,1,2,2,0,1,2,0,1,2};
    
        k_neighbors_classifier_layer_t layer= { n_neighbors, n_samples, n_features, n_classes, neighbors_features, neighbors_id, euclidean_distance };
        return layer;
    }
    
