#include "neural_net.h"
#include "knn.h"
#include "embedia_debug.h"
#include "skl_knn_iris_model.h"
#include "common.h"

// Initialization function prototypes
normalization_layer_t init_Standard_Scaler_data(void);
k_neighbors_classifier_layer_t init_SKL_KNN_iris_model_data(void);


// Global Variables
normalization_layer_t Standard_Scaler_data;
k_neighbors_classifier_layer_t SKL_KNN_iris_model_data;


void model_init(){
    Standard_Scaler_data = init_Standard_Scaler_data();
    SKL_KNN_iris_model_data = init_SKL_KNN_iris_model_data();

}

void model_predict(data1d_t input, data1d_t * output){

    prepare_buffers();

    //******************** LAYER 0 *******************//
    // Layer name: Standard_Scaler
    data1d_t output0;
    standard_norm_layer(Standard_Scaler_data, input, &output0);
    // Debug function for layer Standard_Scaler
    print_data1d_t("Standard_Scaler", output0);

    //******************** LAYER 1 *******************//
    // Layer name: SKL_KNN_iris_model
    input = output0;
    k_neighbors_classifier_layer(SKL_KNN_iris_model_data, input, &output0);

    // Debug function for layer SKL_KNN_iris_model
    print_data1d_t("SKL_KNN_iris_model", output0);


    *output = output0;

}

int model_predict_class(data1d_t input, data1d_t * results){


    model_predict(input, results);

    return argmax(*results);
    //return argmax(data1d_t);

}

// Implementation of initialization functions


normalization_layer_t init_Standard_Scaler_data(void){
    /*[5.80916667 3.06166667 3.72666667 1.18333333]*/
    static const float sub_val[] ={
    5.809166666666665, 3.0616666666666674, 3.726666666666667, 1.1833333333333333
    };
    /*[1.21896909 2.23589719 0.57305675 1.33485032]*/
    static const float inv_div_val[] ={
    1.2189690866760947, 2.2358971863210813, 0.5730567543113094, 1.3348503216138696,

    };

    static const normalization_layer_t norm = { sub_val, inv_div_val  };
    return norm;
}

    k_neighbors_classifier_layer_t init_SKL_KNN_iris_model_data(void){

        uint16_t n_neighbors = 20;
        uint32_t n_samples = 120;
        uint16_t n_features = 4;
        uint16_t n_classes = 3;

        static float neighbors_features[] = {
/* 0 */ -1.473936787305843, 1.2036579853028473, -1.5625347500888371, -1.3126028162536385,
/* 0 */ -0.1330707919621384, 2.9923757343597126, -1.2760063729331825, -1.0456327519308646,
/* 1 */ 1.0858982947139562, 0.08570939214230662, 0.385858214569615, 0.28921756968300494,
/* 0 */ -1.230142969970624, 0.7564785480386306, -1.2187006975020516, -1.3126028162536385,
/* 0 */ -1.7177306046410612, 0.30929911077441496, -1.3906177237954442, -1.3126028162536385,
/* 2 */ 0.598310660043518, -1.2558289196503423, 0.7296922671564005, 0.9566427304899398,
/* 1 */ 0.720207568711128, 0.30929911077441496, 0.44316389000074574, 0.42270260184439207,
/* 0 */ -0.7425553353001857, 0.9800682666707389, -1.2760063729331825, -1.3126028162536385,
/* 0 */ -0.9863491526354048, 1.2036579853028473, -1.3333120483643135, -1.3126028162536385,
/* 0 */ -0.7425553353001857, 2.321606578463387, -1.2760063729331825, -1.4460878484150255,
/* 2 */ -0.011173883294529365, -0.8086494823861257, 0.7869979425875312, 0.9566427304899398,
/* 1 */ 0.23261993404068979, 0.7564785480386306, 0.44316389000074574, 0.5561876340057791,
/* 1 */ 1.0858982947139562, 0.08570939214230662, 0.5577752408630077, 0.42270260184439207,
/* 0 */ -0.49876151796496654, 1.8744271411991713, -1.3906177237954442, -1.0456327519308646,
/* 0 */ -0.49876151796496654, 1.4272477039349556, -1.2760063729331825, -1.3126028162536385,
/* 1 */ -0.37686460929735754, -1.4794186382824506, -0.015281513448301682, -0.2447225589625428,
/* 2 */ 0.598310660043518, -0.5850597637540184, 0.7869979425875312, 0.42270260184439207,
/* 2 */ 0.720207568711128, 0.08570939214230662, 1.0162206443120552, 0.823157698328553,
/* 1 */ 0.9640013860463461, -0.1378803264898017, 0.385858214569615, 0.28921756968300494,
/* 2 */ 1.6953828380520035, 1.2036579853028473, 1.3600546968988405, 1.7575529234582616,
/* 1 */ -0.1330707919621384, -0.36147004512191, 0.271246863707353, 0.15573253752161817,
/* 2 */ 2.182970472722441, -0.1378803264898017, 1.6465830740544953, 1.223612794812714,
/* 1 */ -0.2549677006297485, -0.1378803264898017, 0.44316389000074574, 0.42270260184439207,
/* 0 */ -0.8644522439677959, 0.9800682666707389, -1.3333120483643135, -1.3126028162536385,
/* 2 */ 2.304867381390051, -0.5850597637540184, 1.7038887494856265, 1.0901277626513268,
/* 1 */ -0.011173883294529365, -0.8086494823861257, 0.21394118827622177, -0.2447225589625428,
/* 0 */ -0.7425553353001857, 0.7564785480386306, -1.3333120483643135, -1.3126028162536385,
/* 0 */ -0.9863491526354048, 0.9800682666707389, -1.3906177237954442, -1.1791177840922515,
/* 0 */ -0.8644522439677959, 1.6508374225670628, -1.0467836712086587, -1.0456327519308646,
/* 1 */ -0.9863491526354048, -2.373777512810883, -0.12989286431056365, -0.2447225589625428,
/* 2 */ 0.598310660043518, -0.8086494823861257, 0.6723865917252697, 0.823157698328553,
/* 0 */ -1.230142969970624, 0.7564785480386306, -1.0467836712086587, -1.3126028162536385,
/* 0 */ -0.9863491526354048, -0.1378803264898017, -1.2187006975020516, -1.3126028162536385,
/* 0 */ -0.8644522439677959, 0.5328888294065223, -1.1613950220709208, -0.9121477197694776,
/* 1 */ -0.2549677006297485, -0.8086494823861257, 0.271246863707353, 0.15573253752161817,
/* 0 */ -0.8644522439677959, 0.7564785480386306, -1.2760063729331825, -1.3126028162536385,
/* 1 */ -0.1330707919621384, -0.1378803264898017, 0.271246863707353, 0.022247505360231082,
/* 2 */ 2.304867381390051, 1.6508374225670628, 1.7038887494856265, 1.357097826974101,
/* 0 */ -1.473936787305843, 0.30929911077441496, -1.3333120483643135, -1.3126028162536385,
/* 1 */ 0.4764137513759089, -0.36147004512191, 0.32855253913848376, 0.15573253752161817,
/* 2 */ -0.1330707919621384, -1.2558289196503423, 0.7296922671564005, 1.0901277626513268,
/* 0 */ -0.37686460929735754, 2.545196297095496, -1.3333120483643135, -1.3126028162536385,
/* 2 */ 0.23261993404068979, -0.1378803264898017, 0.6150809162941384, 0.823157698328553,
/* 2 */ -0.011173883294529365, -0.8086494823861257, 0.7869979425875312, 0.9566427304899398,
/* 1 */ 0.23261993404068979, -1.9265980755466663, 0.15663551284509103, -0.2447225589625428,
/* 1 */ -0.49876151796496654, -0.1378803264898017, 0.44316389000074574, 0.42270260184439207,
/* 2 */ 0.4764137513759089, 0.7564785480386306, 0.9589149688809244, 1.4905828591354875,
/* 1 */ -0.37686460929735754, -1.7030083569145589, 0.15663551284509103, 0.15573253752161817,
/* 0 */ -0.49876151796496654, 1.8744271411991713, -1.1613950220709208, -1.0456327519308646,
/* 1 */ -0.9863491526354048, -1.7030083569145589, -0.24450421517282564, -0.2447225589625428,
/* 2 */ 0.720207568711128, -0.8086494823861257, 0.9016092934497931, 0.9566427304899398,
/* 0 */ -0.9863491526354048, 0.5328888294065223, -1.3333120483643135, -1.3126028162536385,
/* 0 */ -0.9863491526354048, 0.30929911077441496, -1.4479233992265754, -1.3126028162536385,
/* 1 */ -0.37686460929735754, -1.4794186382824506, 0.04202416198282905, -0.1112375268011557,
/* 1 */ 1.0858982947139562, -0.1378803264898017, 0.7296922671564005, 0.6896726661671659,
/* 0 */ -1.1082460613030138, 0.08570939214230662, -1.2760063729331825, -1.3126028162536385,
/* 2 */ -0.011173883294529365, -0.5850597637540184, 0.7869979425875312, 1.6240678912968747,
/* 0 */ -0.9863491526354048, 0.7564785480386306, -1.2760063729331825, -1.3126028162536385,
/* 0 */ -0.9863491526354048, 0.9800682666707389, -1.2187006975020516, -0.7786626876080907,
/* 1 */ 0.11072302537308075, 0.30929911077441496, 0.6150809162941384, 0.823157698328553,
/* 1 */ -0.8644522439677959, -1.2558289196503423, -0.4164212414662184, -0.1112375268011557,
/* 2 */ 1.3296921120491754, 0.30929911077441496, 1.130831995174317, 1.4905828591354875,
/* 1 */ 0.23261993404068979, -0.8086494823861257, 0.7869979425875312, 0.5561876340057791,
/* 2 */ 0.3545168427082988, -1.032239201018234, 1.073526319743186, 0.28921756968300494,
/* 2 */ 2.304867381390051, -0.1378803264898017, 1.3600546968988405, 1.4905828591354875,
/* 1 */ -0.37686460929735754, -1.2558289196503423, 0.15663551284509103, 0.15573253752161817,
/* 0 */ -1.7177306046410612, -0.36147004512191, -1.3333120483643135, -1.3126028162536385,
/* 0 */ -1.8396275133086712, -0.1378803264898017, -1.5052290746577062, -1.4460878484150255,
/* 2 */ 0.23261993404068979, -1.9265980755466663, 0.7296922671564005, 0.42270260184439207,
/* 2 */ 1.6953828380520035, 0.30929911077441496, 1.3027490214677098, 0.823157698328553,
/* 0 */ -1.473936787305843, 0.08570939214230662, -1.2760063729331825, -1.3126028162536385,
/* 0 */ -0.8644522439677959, 0.9800682666707389, -1.3333120483643135, -1.1791177840922515,
/* 0 */ -1.7177306046410612, -0.1378803264898017, -1.3906177237954442, -1.3126028162536385,
/* 1 */ 0.598310660043518, -1.2558289196503423, 0.6723865917252697, 0.42270260184439207,
/* 2 */ 0.598310660043518, 0.7564785480386306, 1.073526319743186, 1.6240678912968747,
/* 0 */ -1.473936787305843, 0.7564785480386306, -1.3333120483643135, -1.1791177840922515,
/* 2 */ 1.2077952033815653, -0.1378803264898017, 1.0162206443120552, 1.223612794812714,
/* 2 */ 0.598310660043518, 0.5328888294065223, 1.3027490214677098, 1.7575529234582616,
/* 0 */ -1.352039878638233, 0.30929911077441496, -1.3906177237954442, -1.3126028162536385,
/* 1 */ 0.3545168427082988, -0.36147004512191, 0.5577752408630077, 0.28921756968300494,
/* 1 */ 0.8421044773787371, -0.5850597637540184, 0.5004695654318765, 0.42270260184439207,
/* 2 */ 0.4764137513759089, -0.5850597637540184, 0.6150809162941384, 0.823157698328553,
/* 1 */ 1.4515890207167843, 0.30929911077441496, 0.5577752408630077, 0.28921756968300494,
/* 2 */ 0.720207568711128, 0.30929911077441496, 0.9016092934497931, 1.4905828591354875,
/* 0 */ -0.8644522439677959, 1.6508374225670628, -1.2187006975020516, -1.3126028162536385,
/* 2 */ 1.3296921120491754, 0.08570939214230662, 0.9589149688809244, 1.223612794812714,
/* 1 */ 0.11072302537308075, -0.1378803264898017, 0.271246863707353, 0.42270260184439207,
/* 2 */ 0.8421044773787371, -0.1378803264898017, 0.8443036180186624, 1.0901277626513268,
/* 1 */ -0.1330707919621384, -1.032239201018234, -0.12989286431056365, -0.2447225589625428,
/* 1 */ -0.7425553353001857, -0.8086494823861257, 0.09932983741396005, 0.28921756968300494,
/* 1 */ 0.3545168427082988, -0.1378803264898017, 0.5004695654318765, 0.28921756968300494,
/* 0 */ -1.595833695973452, -1.7030083569145589, -1.3906177237954442, -1.1791177840922515,
/* 1 */ 0.9640013860463461, -0.36147004512191, 0.5004695654318765, 0.15573253752161817,
/* 1 */ -0.37686460929735754, -1.032239201018234, 0.385858214569615, 0.022247505360231082,
/* 0 */ -0.6206584266325766, 1.4272477039349556, -1.2760063729331825, -1.3126028162536385,
/* 1 */ -0.2549677006297485, -0.1378803264898017, 0.21394118827622177, 0.15573253752161817,
/* 2 */ 1.8172797467196125, -0.36147004512191, 1.4746660477611027, 0.823157698328553,
/* 2 */ 1.0858982947139562, 0.5328888294065223, 1.130831995174317, 1.223612794812714,
/* 0 */ -0.8644522439677959, 1.4272477039349556, -1.2760063729331825, -1.0456327519308646,
/* 1 */ -1.1082460613030138, -1.4794186382824506, -0.24450421517282564, -0.2447225589625428,
/* 2 */ 1.0858982947139562, 0.5328888294065223, 1.130831995174317, 1.7575529234582616,
/* 2 */ 1.6953828380520035, -0.1378803264898017, 1.1881376706054478, 0.5561876340057791,
/* 0 */ -1.1082460613030138, 1.2036579853028473, -1.3333120483643135, -1.4460878484150255,
/* 2 */ 1.0858982947139562, 0.08570939214230662, 1.073526319743186, 1.6240678912968747,
/* 0 */ -1.1082460613030138, -0.1378803264898017, -1.3333120483643135, -1.3126028162536385,
/* 1 */ 1.3296921120491754, 0.08570939214230662, 0.6723865917252697, 0.42270260184439207,
/* 2 */ 1.9391766553872227, -0.5850597637540184, 1.3600546968988405, 0.9566427304899398,
/* 2 */ 0.598310660043518, -0.36147004512191, 1.073526319743186, 0.823157698328553,
/* 1 */ -0.1330707919621384, -0.5850597637540184, 0.21394118827622177, 0.15573253752161817,
/* 2 */ 0.8421044773787371, -0.1378803264898017, 1.0162206443120552, 0.823157698328553,
/* 1 */ 0.598310660043518, -1.7030083569145589, 0.385858214569615, 0.15573253752161817,
/* 1 */ 0.720207568711128, -0.36147004512191, 0.32855253913848376, 0.15573253752161817,
/* 2 */ -0.2549677006297485, -0.5850597637540184, 0.6723865917252697, 1.0901277626513268,
/* 2 */ 0.11072302537308075, -0.1378803264898017, 0.7869979425875312, 0.823157698328553,
/* 0 */ -0.49876151796496654, 0.7564785480386306, -1.1613950220709208, -1.3126028162536385,
/* 1 */ 0.3545168427082988, -0.5850597637540184, 0.15663551284509103, 0.15573253752161817,
/* 2 */ -1.1082460613030138, -1.2558289196503423, 0.44316389000074574, 0.6896726661671659,
/* 0 */ -0.011173883294529365, 2.0980168598312794, -1.4479233992265754, -1.3126028162536385,
/* 1 */ -0.011173883294529365, -1.032239201018234, 0.15663551284509103, 0.022247505360231082,
/* 2 */ 1.5734859293843935, -0.1378803264898017, 1.245443346036579, 1.223612794812714,
};
        static uint16_t neighbors_id[] = {0,0,1,0,0,2,1,0,0,0,2,1,1,0,0,1,2,2,1,2,1,2,1,0,2,1,0,0,0,1,2,0,0,0,1,0,1,2,0,1,2,0,2,2,1,1,2,1,0,1,2,0,0,1,1,0,2,0,0,1,1,2,1,2,2,1,0,0,2,2,0,0,0,1,2,0,2,2,0,1,1,2,1,2,0,2,1,2,1,1,1,0,1,1,0,1,2,2,0,1,2,2,0,2,0,1,2,2,1,2,1,1,2,2,0,1,2,0,1,2};

        k_neighbors_classifier_layer_t layer= { n_neighbors, n_samples, n_features, n_classes, neighbors_features, neighbors_id};
        return layer;
    }

